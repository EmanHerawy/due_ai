version: '3.8'

services:
  # ==========================================================================
  # OpenClaw Gateway - The main AI agent that connects to messaging platforms
  # ==========================================================================
  openclaw-gateway:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-gateway
    entrypoint: ["sh", "-c", "npx -y mcporter@latest --version && exec docker-entrypoint.sh \"$@\"", "--"]
    command: ["node", "dist/index.js", "gateway", "--verbose"]
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allows container to reach host (for Ollama)
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:${OPENCLAW_GATEWAY_PORT:-18789}"
    volumes:
      # OpenClaw state dir (config + runtime state like canvas, cron, sessions)
      - ./.openclaw:/home/node/.openclaw
      # mcporter config — must be at ~/.mcporter for default discovery
      - ./.mcporter:/home/node/.mcporter
      # Mount our MCP server for mcporter to access
      - ./:/home/node/web3-mcp-server:ro
    environment:
      - NODE_ENV=production
      # mcporter config discovery — must point to the actual config file
      - MCPORTER_CONFIG=/home/node/.mcporter/mcporter.json
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      # LLM provider keys — set the one(s) matching your OPENCLAW_MODEL
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Channel tokens
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
    networks:
      - openclaw-network
    restart: unless-stopped
    depends_on:
      - due-ai-web3-mcp

  # ==========================================================================
  # OpenClaw CLI - For onboarding and configuration
  # ==========================================================================
  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-cli
    volumes:
      - ./.openclaw:/home/node/.openclaw
      - ./.mcporter:/home/node/.mcporter
      - ./:/home/node/web3-mcp-server:ro
    environment:
      - MCPORTER_CONFIG=/home/node/.mcporter/mcporter.json
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
    networks:
      - openclaw-network
    profiles:
      - cli  # Only runs when explicitly called

  # ==========================================================================
  # Due AI Web3 MCP Server - Our custom Sui blockchain tools
  # ==========================================================================
  due-ai-web3-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: due-ai-web3-mcp
    environment:
      - NODE_ENV=production
      - SUI_NETWORK=${SUI_NETWORK:-testnet}
    # stdio transport - OpenClaw connects via mcporter
    stdin_open: true
    tty: true
    networks:
      - openclaw-network
    restart: unless-stopped

networks:
  openclaw-network:
    driver: bridge
